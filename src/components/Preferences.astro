---
import ThemeSwitcher from "./ThemeSwitcher";
import FontSwitcher from "./FontSwitcher";
import LineNumberToggle from "./LineNumberToggle";
---

<div class="preferences-toggle">
  <button
    id="preferences-toggle-btn"
    aria-label="Mostrar/ocultar preferencias"
    title="Preferencias"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 24 24"
      width="24"
      height="24"
      class="preferences-icon"
    >
      <!-- Gear/settings icon that can transform to X -->
      <circle
        class="preferences-icon-circle"
        cx="12"
        cy="12"
        r="4"
        fill="none"
        stroke="currentColor"
        stroke-width="2"></circle>
      <path
        class="preferences-icon-tooth preferences-icon-tooth-top"
        d="M12 2v4"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"></path>
      <path
        class="preferences-icon-tooth preferences-icon-tooth-right"
        d="M22 12h-4"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"></path>
      <path
        class="preferences-icon-tooth preferences-icon-tooth-bottom"
        d="M12 22v-4"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"></path>
      <path
        class="preferences-icon-tooth preferences-icon-tooth-left"
        d="M2 12h4"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"></path>
      <path
        class="preferences-icon-tooth preferences-icon-tooth-top-right"
        d="M18.36 5.64l-2.83 2.83"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"></path>
      <path
        class="preferences-icon-tooth preferences-icon-tooth-bottom-right"
        d="M18.36 18.36l-2.83-2.83"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"></path>
      <path
        class="preferences-icon-tooth preferences-icon-tooth-bottom-left"
        d="M5.64 18.36l2.83-2.83"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"></path>
      <path
        class="preferences-icon-tooth preferences-icon-tooth-top-left"
        d="M5.64 5.64l2.83 2.83"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"></path>
    </svg>
  </button>
</div>

<aside id="preferences" class="preferences">
  <div class="preferences-content">
    <h3 class="preferences-title">Preferencias</h3>
    <div class="preferences-switchers">
      <div class="preferences-group">
        <h4>Tema</h4>
        <ThemeSwitcher client:load />
      </div>
      <div class="preferences-group">
        <h4>Fuente</h4>
        <FontSwitcher client:load />
      </div>
      <div class="preferences-group">
        <h4>CÃ³digo</h4>
        <LineNumberToggle client:load />
      </div>
    </div>
  </div>
</aside>

<style>
  .preferences-toggle {
    position: fixed;
    z-index: 10;
    top: calc(var(--navbar-height) + 0.75em);
    right: 10px;
  }

  #preferences-toggle-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: transparent;
    color: var(--foreground-color);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 0 5px rgba(var(--accent-color-rgb), 0.5);
    transition:
      transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275),
      background-color 0.3s ease,
      box-shadow 0.3s ease;
    will-change: transform;
  }

  .preferences-icon {
    transition: transform 0.4s ease;
  }

  .preferences-title {
    color: var(--foreground-color);
  }

  .preferences-icon path,
  .preferences-icon circle {
    transition:
      transform 0.4s cubic-bezier(0.68, -0.6, 0.32, 1.6),
      opacity 0.3s ease-in-out,
      stroke-width 0.3s ease;
    transform-origin: center;
  }

  #preferences-toggle-btn.active {
    transform: rotate(90deg) scale(0.95);
    background-color: transparent;
    box-shadow: 0 0 8px rgba(var(--accent-color-rgb), 0.7);
  }

  /* Hide all gear teeth when active */
  #preferences-toggle-btn.active .preferences-icon-tooth {
    opacity: 0;
  }

  /* Hide the circle when active */
  #preferences-toggle-btn.active .preferences-icon-circle {
    opacity: 0;
  }

  #preferences-toggle-btn.active .preferences-icon-tooth {
    background-color: transparent;
    color: var(--accent-muted-color);
  }

  #preferences-toggle-btn.active:hover .preferences-icon-tooth {
    background-color: var(--accent-color);
    color: var(--foreground-color);
  }

  /* Transform top-right and bottom-left teeth into the X */
  #preferences-toggle-btn.active .preferences-icon-tooth-top-right {
    opacity: 1;
    transform: translate(-6px, 6px) scale(2) rotate(0);
    stroke-width: 1.5;
  }

  #preferences-toggle-btn.active .preferences-icon-tooth-bottom-left {
    opacity: 1;
    transform: translate(6px, -6px) scale(2) rotate(0);
    stroke-width: 1.5;
  }

  /* Transform top-left and bottom-right teeth into the X */
  #preferences-toggle-btn.active .preferences-icon-tooth-top-left {
    opacity: 1;
    transform: translate(6px, 6px) scale(2) rotate(0);
    stroke-width: 1.5;
  }

  #preferences-toggle-btn.active .preferences-icon-tooth-bottom-right {
    opacity: 1;
    transform: translate(-6px, -6px) scale(2) rotate(0);
    stroke-width: 1.5;
  }

  #preferences-toggle-btn:hover {
    background-color: var(--accent-color);
    box-shadow: 0 0 5px rgba(var(--accent-color-rgb), 0.5);
  }

  #preferences-toggle-btn.active:hover {
    background-color: var(--accent-muted-color);
    box-shadow: 0 0 5px rgba(var(--accent-color-rgb), 0.5);
  }

  #preferences-toggle-btn:hover .preferences-icon path,
  #preferences-toggle-btn:hover .preferences-icon circle {
    color: var(--foreground-color);
    stroke-width: 1.5;
  }

  .preferences {
    position: fixed;
    top: calc(var(--navbar-height) + 1px);
    right: -302px;
    width: 302px;
    height: calc(100vh - 81px);
    background-image: var(--navigation-background-image);
    background-repeat: repeat;
    backdrop-filter: blur(10px);
    z-index: 9;
    transition: right 0.3s ease;
    overflow-y: auto;
    box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);

    &.expanded {
      border-left: none;
    }

    @media screen and (min-width: 992px) {
      right: -28dvw;
      width: 28dvw;
      height: calc(100vh - 91px);
    }
  }

  .preferences.active {
    right: 0;
  }

  .preferences-content {
    padding: 20px;
  }

  h3 {
    margin-bottom: 20px;
    color: var(--accent-color);
  }

  .preferences-switchers {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .preferences-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  h4 {
    margin-bottom: 5px;
    color: var(--foreground-color);
  }

  @media screen and (max-width: 992px) {
    .preferences {
      width: 256px;
    }
  }
</style>

<script>
  // Toggle preferences visibility
  const preferencesToggleBtn = document.getElementById(
    "preferences-toggle-btn",
  );
  const preferences = document.getElementById("preferences");

  preferencesToggleBtn?.addEventListener("click", () => {
    preferences?.classList.toggle("active");
    preferencesToggleBtn.classList.toggle("active");
  });

  // Close the preferences when clicking outside
  document.addEventListener("click", (event) => {
    const target = event.target as HTMLElement;
    if (
      preferences?.classList.contains("active") &&
      !preferences.contains(target) &&
      !preferencesToggleBtn?.contains(target)
    ) {
      preferences.classList.remove("active");
      preferencesToggleBtn?.classList.remove("active");
    }
  });
</script>
